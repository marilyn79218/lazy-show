name: dependabot PR CI

on:
  workflow_run:
    workflows: ["Upload data at PR CI phase"]
    types:
      - completed

jobs:
  dependabot-comments:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Get PR info
        id: get_pr_info
        uses: actions/github-script@v4
        with:
          script: |
            const path = require('path');
            const scriptPath = path.resolve('./.github/workflows/get-pr-info.js');
            const commitHash = `${{ github.event.workflow_run.head_sha }}`
            await require(scriptPath)(github, context, core, commitHash);
      - name: Display PR info
        run: |
          echo "PR outputs - ${{ steps.get_pr_info.outputs }}"
          echo "PR number - ${{ steps.get_pr_info.outputs.prNumber }}"
          echo "PR list (new) - ${{ github.event.workflow_run.pull_requests }}"
          echo "PR branch (new) - ${{ github.event.workflow_run.head_branch }}"
      - name: List PR list
        id: list_pr_info
        uses: actions/github-script@v4
        with:
          script: |
            const path = require('path');
            const scriptPath = path.resolve('./.github/workflows/list-pr-info.js');
            const prList = ${{ github.event.workflow_run.pull_requests }};
            await require(scriptPath)(github, context, core, prList);
      - name: Download artifact once bundlesize done
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: pr-upload-data.yml
          name: data-arctifact
          branch: ${{ github.event.workflow_run.head_branch }}
      - name: Display structure of downloaded files
        run: ls -R
        working-directory: .
      - name: Collect data
        id: collect_data
        run: echo "::set-output name=downloadedData::$(node ./.github/workflows/download-cross-workflow-artifact.js)"
      - name: Post results to Log console
        run: echo "The downloaded ramdom number is ${{ steps.collect_data.outputs.downloadedData }}"
      - name: "Writing comments"
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const path = require('path');
            const scriptPath = path.resolve('./.github/workflows/writing-comments.js');
            const writingData = ${{ steps.collect_data.outputs.downloadedData }};
            await require(scriptPath)(github, context, core, writingData);